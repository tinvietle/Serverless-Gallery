# Deploy Lambda functions when changes are pushed to main
# Automatically detects which Lambda folders have changed and deploys only those

name: Deploy Lambdas

on:
  push:
    branches:
      - main
    paths:
      - 'Lambda*/**'
      - 'lambda-config.json'
  workflow_dispatch:
    inputs:
      lambda_name:
        description: 'Lambda to deploy (leave empty for all changed, "all" for all lambdas)'
        required: false
        default: ''
      force_deploy:
        description: 'Force deploy even if no changes detected'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1

jobs:
  detect-changes:
    name: Detect Changed Lambdas
    runs-on: ubuntu-latest
    outputs:
      lambdas: ${{ steps.detect.outputs.lambdas }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed Lambda folders
        id: detect
        run: |
          # If manual trigger with specific lambda
          if [ "${{ github.event.inputs.lambda_name }}" != "" ]; then
            if [ "${{ github.event.inputs.lambda_name }}" == "all" ]; then
              # Get all lambdas from config
              LAMBDAS=$(jq -r '.lambdas | keys | @json' lambda-config.json)
            else
              LAMBDAS='["${{ github.event.inputs.lambda_name }}"]'
            fi
            echo "lambdas=$LAMBDAS" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          
          # Extract unique Lambda folder names
          CHANGED_LAMBDAS=$(echo "$CHANGED_FILES" | grep "^Lambda" | cut -d'/' -f1 | sort -u)
          
          # Filter to only include configured lambdas
          VALID_LAMBDAS=()
          for dir in $CHANGED_LAMBDAS; do
            if jq -e ".lambdas[\"$dir\"]" lambda-config.json &> /dev/null; then
              VALID_LAMBDAS+=("$dir")
            fi
          done

          if [ ${#VALID_LAMBDAS[@]} -eq 0 ]; then
            echo "No Lambda changes detected"
            echo "lambdas=[]" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            # Convert to JSON array (compact format for GITHUB_OUTPUT)
            LAMBDAS_JSON=$(printf '%s\n' "${VALID_LAMBDAS[@]}" | jq -R . | jq -sc .)
            echo "Changed lambdas: $LAMBDAS_JSON"
            echo "lambdas=$LAMBDAS_JSON" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  build-and-deploy:
    name: Build & Deploy
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' || github.event.inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lambda: ${{ fromJson(needs.detect-changes.outputs.lambdas) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: maven

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Lambda config
        id: config
        run: |
          FUNCTION_NAME=$(jq -r ".lambdas[\"${{ matrix.lambda }}\"].functionName" lambda-config.json)
          HANDLER=$(jq -r ".lambdas[\"${{ matrix.lambda }}\"].handler" lambda-config.json)
          echo "function_name=$FUNCTION_NAME" >> $GITHUB_OUTPUT
          echo "handler=$HANDLER" >> $GITHUB_OUTPUT
          echo "Deploying ${{ matrix.lambda }} as $FUNCTION_NAME"

      - name: Build with Maven
        run: |
          cd ${{ matrix.lambda }}
          mvn clean package -DskipTests -q

      - name: Find JAR file
        id: jar
        run: |
          JAR_PATH=$(find ${{ matrix.lambda }}/target -name "*.jar" ! -name "*original*" -type f | head -1)
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_PATH"

      - name: Deploy to AWS Lambda
        run: |
          echo "Updating function: ${{ steps.config.outputs.function_name }}"
          
          aws lambda update-function-code \
            --function-name ${{ steps.config.outputs.function_name }} \
            --zip-file fileb://${{ steps.jar.outputs.jar_path }} \
            --region ${{ env.AWS_REGION }}
          
          echo "Waiting for update to complete..."
          aws lambda wait function-updated \
            --function-name ${{ steps.config.outputs.function_name }} \
            --region ${{ env.AWS_REGION }}
          
          echo "✓ Successfully deployed ${{ steps.config.outputs.function_name }}"

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Project | ${{ matrix.lambda }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Function | ${{ steps.config.outputs.function_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Completion
    needs: [detect-changes, build-and-deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Lambda Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
            echo "✅ All deployments completed successfully!" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.detect-changes.outputs.has_changes }}" == "false" ]; then
            echo "ℹ️ No Lambda changes detected - skipped deployment" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some deployments failed. Check individual job logs." >> $GITHUB_STEP_SUMMARY
          fi

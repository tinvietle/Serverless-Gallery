<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/JSP_Servlet/Html.html to edit this template
-->
<html>

<head>
    <title>Bucket List</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        table,
        th,
        td {
            border: 1px solid;
        }
        .gallery-section {
            display: none;
        }
        .gallery-section.show {
            display: block;
        }
    </style>

</head>

<body>
    <div>
        <label for="email">Email:</label>
        <input type="text" id="email" name="email"> 
        <button id="email_button" onclick="getTokenForUser()">Login</button>
    </div>

    <div>
        <label for="token">Token:</label>
        <input type="text" id="token" name="token" size="100">
    </div>
    

    <div>
        <label for="File_input">file: </label>
        <input type="file" id="file_input">
        <!-- <button id="upload_button" onclick="uploadObject(); insertDescription();">Upload</button> -->
        <button id="upload_button" onclick="triggerUploadFileAndDescription()">Upload</button>
    </div>

    <label for="Description">Description:</label>
    <input type="text" id="Description" name="Description" placeholder="Put some text here...">

    <br><br>
    <button id="ListButton" onclick="fetchListOfObjects()">List</button>
    <div class="gallery-section">
        <h1>Photo Gallery</h1>
    </div>
    <div class="gallery-section">
        <table id="objectsTable">
        </table>
    </div>
    <div class="gallery-section">
        <img src="" id="download_image" alt="Downloaded image will be here">
    </div>
    <script>
        //getObjectList();
        //fetchListOfObjects();

        function deleteObject(filename) {
            let url = "https://amemfkr74omup6c6ycoxtf42ge0wyofo.lambda-url.us-east-1.on.aws/";
            const body = {
                "email": document.getElementById('email').value,
                "token": document.getElementById('token').value,
                "key": filename
            };
            fetch(url, {
                method: 'DELETE',
                body: JSON.stringify(body)
            })
                .then((resp) => {
                    if (!resp.ok) {
                        alert("Error deleting file. Status: " + resp.status);
                        // Hide gallery sections
                        document.querySelectorAll('.gallery-section').forEach(el => el.classList.remove('show'));
                        throw new Error(`HTTP error, status = ${resp.status}`);
                    }
                    return resp.text();
                })
                .then(function (response) {
                    fetchListOfObjects();
                    console.info('fetch()', response);
                });
        }

        function renderListOfObjects(listOfObjects) {
            let objectsTable = document.getElementById("objectsTable");
            while (objectsTable.firstChild) {
                objectsTable.removeChild(objectsTable.lastChild);
            }
            let objectsArray = JSON.parse(listOfObjects);

            for (let i = 0; i < objectsArray.length; i = i + 1) {
                let row = document.createElement("tr");
                let keyCell = document.createElement("td");
                keyCell.innerHTML = objectsArray[i].S3Key;
                /* */
                let imageCell = document.createElement("td");
                let img = document.createElement("img");
                img.style.objectFit = "cover";
                img.alt = "Loading...";
                imageCell.appendChild(img);
                fetchThumbnail(objectsArray[i].S3Key, img);
                /* */
                let descriptionCell = document.createElement("td");
                let descriptionText = objectsArray[i].Description || "No description";
                descriptionCell.innerHTML = descriptionText;
                /* */
                let downloadCell = document.createElement("td");
                let downloadButton = document.createElement("button");
                downloadButton.addEventListener("click", function () {
                    //downloadObject(objectsArray[i].S3Key);
                    fetchObject(objectsArray[i].S3Key)
                });
                /* */
                let emailCell = document.createElement("td");
                emailCell.innerHTML = objectsArray[i].Email || "No email";
                /* */
                downloadButton.innerHTML = "Download";
                downloadCell.appendChild(downloadButton);
                /* */
                let deleteCell = document.createElement("td");
                let deleteButton = document.createElement("button");
                deleteButton.addEventListener("click", function () {
                    deleteObject(objectsArray[i].S3Key);
                });
                deleteButton.innerHTML = "Delete";
                deleteCell.appendChild(deleteButton);
                /* */
                row.appendChild(imageCell);
                row.appendChild(keyCell);
                row.appendChild(descriptionCell);
                row.appendChild(emailCell);
                row.appendChild(downloadCell);
                row.appendChild(deleteCell);
                objectsTable.appendChild(row);
            }

        }

        function fetchListOfObjects() {
            const body = {
                "email": document.getElementById('email').value,
                "token": document.getElementById('token').value
            }
            let url = "https://4ppxzno45ostxgonxljjkeehmm0siotc.lambda-url.us-east-1.on.aws/";
            fetch(url,
                {
                    method: 'POST',
                    body: JSON.stringify(body)
                }
            )
                .then((response) => {
                    if (!response.ok) {
                        alert("Error fetching object list. Status: " + response.status);
                        // Hide gallery sections
                        document.querySelectorAll('.gallery-section').forEach(el => el.classList.remove('show'));
                        throw new Error(`HTTP error, status = ${response.status}`);
                    }
                    return response.text();
                })
                .then((text) => {
                    // Decode base64 response
                    const decodedText = atob(text);
                    // Show gallery sections
                    document.querySelectorAll('.gallery-section').forEach(el => el.classList.add('show'));
                    renderListOfObjects(decodedText);
                })
                .catch((error) => {
                    console.log(`Error: ${error.message}`);
                });

        }


        function fetchObject(key) {
            const body = {
                "email": document.getElementById('email').value,
                "token": document.getElementById('token').value,
                "key": key
            };
            let url = "https://hl4vd5fzqtxirbwgmqwunklijm0ksibx.lambda-url.us-east-1.on.aws/";

            fetch(url, {
                method: 'POST',
                body: JSON.stringify(body)
            })
                .then(response => {
                    if (!response.ok) {
                        alert("Error fetching object. Status: " + response.status);
                        // Hide gallery sections
                        document.querySelectorAll('.gallery-section').forEach(el => el.classList.remove('show'));
                        throw new Error(`HTTP error, status = ${response.status}`);
                    }
                    return response.text();
                })
                .then((base64Data) => {
                    // Decode base64 to binary string
                    const binaryString = atob(base64Data);
                    // Convert binary string to byte array
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    // Create blob from byte array
                    const myBlob = new Blob([bytes]);
                    const objectURL = URL.createObjectURL(myBlob);
                    const img_S3 = document.getElementById("download_image");
                    img_S3.src = objectURL;
                })
                .catch((error) => {
                    console.error('Error fetching object:', error);
                });
        }

        function fetchThumbnail(key, imgElement) {
            const body = {
                "key": "resized-" + key
            };
            let url = "https://pdgq4una5vr233h5k3emxttyha0pqfzi.lambda-url.us-east-1.on.aws/";

            fetch(url, {
                method: 'POST',
                body: JSON.stringify(body)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Thumbnail not ready');
                    }
                    return response.blob();
                })
                .then((myBlob) => {
                    const objectURL = URL.createObjectURL(myBlob);
                    imgElement.src = objectURL;
                    imgElement.alt = key;
                })
                .catch((error) => {
                    // Fallback: show placeholder or original image key
                    imgElement.alt = "Thumbnail processing...";
                    // if the name is cloud-public.html, do nothing
                    if (key === "cloud-public.html") {
                        imgElement.alt = "No thumbnail";
                        return;
                    }
                    // Retry after 2 seconds
                    setTimeout(() => {
                        fetchThumbnail(key, imgElement);
                    }, 2000);                    
                });
        }

        /* DOWNLOAD OBJECT */
        function downloadObject(key) {
            const xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status === 200) {
                    // Create a blob URL
                    const blob = xhr.response;
                    const url = window.URL.createObjectURL(blob);

                    // Create a temporary link element
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = key; // Use the filename from the key

                    // Trigger download
                    document.body.appendChild(a);
                    a.click();

                    // Cleanup
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    console.log("Error: " + xhr.status);
                    alert("Error downloading file. Status: " + xhr.status);
                }
            };
            xhr.open("POST", "https://hl4vd5fzqtxirbwgmqwunklijm0ksibx.lambda-url.us-east-1.on.aws/");
            const body1 = JSON.stringify({
                "email": document.getElementById('email').value,
                "token": document.getElementById('token').value,
                "key": key
            });
            xhr.responseType = 'blob';
            xhr.send(body1);
        }

        function triggerUploadFileAndDescription(){
            let file_input = document.getElementById("file_input");
            let file = file_input.files[0];
            let reader = new FileReader();
            const description = document.getElementById('Description').value;
            let url = "https://qvvso5khyuv4ficypqlgc4heae0layfh.lambda-url.us-east-1.on.aws/";
            reader.onload = () => {
                //The Uint8Array allows you to read and write individual
                //bytes within the ArrayBuffer using array-like indexing.
                const uint8Array = new Uint8Array(reader.result);
                //The toBase64() method of Uint8Array instances returns a base64-encoded string
                //based on the data in this Uint8Array object.
                const body = {
                    "content": uint8Array.toBase64(),
                    "key": file.name,
                    "description": description,
                    "email": document.getElementById('email').value,
                    "token": document.getElementById('token').value
                };
                fetch(url, {
                    method: 'PUT',
                    body: JSON.stringify(body)
                })
                    .then((resp) => {
                        if (!resp.ok) {
                            alert("Error uploading file. Status: " + resp.status);
                            // Hide gallery sections
                            document.querySelectorAll('.gallery-section').forEach(el => el.classList.remove('show'));
                            throw new Error(`HTTP error, status = ${resp.status}`);
                        }
                        return resp.text();
                    })
                    .then(function (response) {
                        console.info('fetch()', response);
                    })
                    .then(() => {
                        fetchListOfObjects();
                    });
            };
            reader.onerror = (e) => {
                console.log('Error : ' + e.type);
            };
            reader.readAsArrayBuffer(file);
        }

        function getTokenForUser() {
            let url = "https://5qwvu7cezahvjskn6cxs3aziti0qyydg.lambda-url.us-east-1.on.aws/";
            const email = document.getElementById('email').value;
            const body = {
                "email": email
            };
            fetch(url, {
                method: 'POST',
                body: JSON.stringify(body)
            })
                .then((resp) => resp.json())
                .then(function (response) {
                    console.info('fetch()', response);
                    if (response.success === false || response.error) {
                        alert("Error: " + response.error);
                        return;
                    }
                    document.getElementById('token').value = response.token;
                    // Alert user about the token
                    alert("Here is your token. Please copy and save it securely.\n\n" + response.token);
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert("Failed to get token: " + error.message);
                });
        };


    </script>
</body>

</html>